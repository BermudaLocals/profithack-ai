# PROFITHACK AI - Web Application Firewall (WAF) Rules
# ModSecurity / Cloudflare / AWS WAF Compatible Configuration

# ============================================================================
# Core Security Rules
# ============================================================================

# Rule Engine Initialization
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecServerSignature "PROFITHACK-WAF"

# ============================================================================
# 1. SQL Injection Protection
# ============================================================================

# Block common SQL injection patterns
SecRule ARGS|REQUEST_HEADERS "@rx (?i:(\bunion\b.{1,100}?\bselect\b|\bselect\b.{1,100}?\bfrom\b))" \
    "id:1001,\
    phase:2,\
    block,\
    t:none,t:urlDecodeUni,t:lowercase,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    severity:'CRITICAL',\
    tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'"

# Block SQL injection in user registration
SecRule REQUEST_URI "@rx ^/api/auth/(register|signup)$" \
    "id:1002,\
    phase:2,\
    chain,\
    t:none,\
    msg:'SQL Injection in Registration'"
    SecRule ARGS "@rx (?i:(union|select|insert|update|delete|drop|alter|exec))" \
        "t:none,t:urlDecodeUni,\
        block"

# ============================================================================
# 2. Cross-Site Scripting (XSS) Protection
# ============================================================================

# Block XSS in GET parameters
SecRule ARGS "@rx <script[^>]*>.*?</script>" \
    "id:2001,\
    phase:2,\
    block,\
    t:none,t:htmlEntityDecode,t:lowercase,\
    msg:'XSS Attack Detected in GET Parameters',\
    severity:'HIGH',\
    tag:'OWASP_CRS/WEB_ATTACK/XSS'"

# Block XSS in POST body
SecRule REQUEST_BODY "@rx (?i:<script|javascript:|onerror=|onload=)" \
    "id:2002,\
    phase:2,\
    block,\
    t:none,t:htmlEntityDecode,\
    msg:'XSS Attack Detected in POST Body',\
    severity:'HIGH'"

# Block XSS in video descriptions/comments
SecRule REQUEST_URI "@rx ^/api/(videos/upload|comments)$" \
    "id:2003,\
    phase:2,\
    chain,\
    msg:'XSS in User Content'"
    SecRule ARGS:description|ARGS:comment "@rx (?i:<script|javascript:|onerror)" \
        "block"

# ============================================================================
# 3. DDoS Protection & Rate Limiting
# ============================================================================

# Rate limit: API calls per IP
SecAction "id:3001,\
    phase:1,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.api_requests=+1,\
    expirevar:ip.api_requests=60"

SecRule IP:API_REQUESTS "@gt 100" \
    "id:3002,\
    phase:2,\
    deny,status:429,\
    msg:'Rate limit exceeded: 100 requests per minute',\
    logdata:'IP: %{REMOTE_ADDR} made %{IP.API_REQUESTS} requests'"

# Rate limit: Video uploads per user
SecRule REQUEST_URI "@rx ^/api/videos/upload$" \
    "id:3003,\
    phase:1,\
    pass,\
    initcol:user=%{REQUEST_HEADERS.Authorization},\
    setvar:user.uploads=+1,\
    expirevar:user.uploads=3600"

SecRule USER:UPLOADS "@gt 10" \
    "id:3004,\
    phase:2,\
    deny,status:429,\
    msg:'Upload rate limit: 10 videos per hour'"

# Rate limit: Login attempts
SecRule REQUEST_URI "@rx ^/api/auth/login$" \
    "id:3005,\
    phase:1,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.login_attempts=+1,\
    expirevar:ip.login_attempts=300"

SecRule IP:LOGIN_ATTEMPTS "@gt 5" \
    "id:3006,\
    phase:2,\
    deny,status:429,\
    msg:'Too many login attempts: locked for 5 minutes'"

# ============================================================================
# 4. Payment Security
# ============================================================================

# Only allow HTTPS for payment endpoints
SecRule REQUEST_URI "@rx ^/api/payments/" \
    "id:4001,\
    phase:1,\
    chain,\
    msg:'Payment must use HTTPS'"
    SecRule REQUEST_SCHEME "!@streq https" \
        "deny,status:403"

# Validate credit card numbers (basic Luhn check)
SecRule ARGS:cardNumber "@validateByteRange 48-57" \
    "id:4002,\
    phase:2,\
    pass,\
    msg:'Credit card validation'"

# Block payment requests with suspicious amounts
SecRule REQUEST_URI "@rx ^/api/payments/" \
    "id:4003,\
    phase:2,\
    chain"
    SecRule ARGS:amount "@rx ^(0\.01|999999|[0-9]{7,})$" \
        "block,\
        msg:'Suspicious payment amount detected'"

# ============================================================================
# 5. Authentication & Session Security
# ============================================================================

# Validate JWT token format
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer\s+[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.[A-Za-z0-9-_.+/=]+$" \
    "id:5001,\
    phase:1,\
    pass,\
    msg:'Valid JWT format'"

# Block requests with expired/invalid tokens (would integrate with backend)
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer\s+expired" \
    "id:5002,\
    phase:1,\
    deny,status:401,\
    msg:'Token expired or invalid'"

# ============================================================================
# 6. File Upload Security
# ============================================================================

# Restrict file upload size (100MB max)
SecRule REQUEST_BODY "@gt 104857600" \
    "id:6001,\
    phase:2,\
    deny,status:413,\
    msg:'File too large (max 100MB)'"

# Validate video file types
SecRule FILES_TMPNAMES "@validateByteRange 1-255" \
    "id:6002,\
    phase:2,\
    pass,\
    msg:'File upload validation'"

SecRule FILES "@rx (?i:\.(exe|bat|cmd|com|pif|scr|vbs|js|jar|zip|rar))$" \
    "id:6003,\
    phase:2,\
    deny,status:415,\
    msg:'Dangerous file type blocked'"

# Only allow video/image uploads
SecRule REQUEST_URI "@rx ^/api/videos/upload$" \
    "id:6004,\
    phase:2,\
    chain"
    SecRule FILES_NAMES "!@rx (?i:\.(mp4|mov|avi|webm|jpg|jpeg|png|gif))$" \
        "deny,status:415,\
        msg:'Only video/image files allowed'"

# ============================================================================
# 7. Geographic Blocking (Optional)
# ============================================================================

# Block requests from sanctioned countries (if required)
# SecRule REMOTE_ADDR "@geoLookup" \
#     "id:7001,\
#     phase:1,\
#     chain"
#     SecRule GEO:COUNTRY_CODE "@rx ^(KP|IR|SY)$" \
#         "deny,status:403,\
#         msg:'Access denied from blocked country'"

# ============================================================================
# 8. API Endpoint Protection
# ============================================================================

# Only allow POST for sensitive endpoints
SecRule REQUEST_URI "@rx ^/api/(auth/login|payments|videos/upload)$" \
    "id:8001,\
    phase:1,\
    chain"
    SecRule REQUEST_METHOD "!@streq POST" \
        "deny,status:405,\
        msg:'Method not allowed for this endpoint'"

# Require authentication for protected routes
SecRule REQUEST_URI "@rx ^/api/(wallet|messages|premium)" \
    "id:8002,\
    phase:1,\
    chain"
    SecRule &REQUEST_HEADERS:Authorization "@eq 0" \
        "deny,status:401,\
        msg:'Authentication required'"

# ============================================================================
# 9. Content Security Policy (CSP)
# ============================================================================

# Add security headers
Header always set X-Frame-Options "DENY"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Content Security Policy
Header always set Content-Security-Policy "\
    default-src 'self'; \
    script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.profithack.ai; \
    style-src 'self' 'unsafe-inline'; \
    img-src 'self' data: https:; \
    media-src 'self' https:; \
    connect-src 'self' wss: https:; \
    font-src 'self' data:; \
    frame-ancestors 'none'; \
    base-uri 'self'; \
    form-action 'self'"

# ============================================================================
# 10. IP Reputation & Threat Intelligence
# ============================================================================

# Block known malicious IPs (integrate with threat feeds)
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/waf/blocked-ips.txt" \
    "id:10001,\
    phase:1,\
    deny,status:403,\
    msg:'Request from blocked IP address'"

# Block Tor exit nodes (optional)
# SecRule REMOTE_ADDR "@ipMatchFromFile /etc/waf/tor-exit-nodes.txt" \
#     "id:10002,\
#     phase:1,\
#     deny,status:403,\
#     msg:'Tor exit nodes blocked'"

# ============================================================================
# Logging & Monitoring
# ============================================================================

SecAuditEngine RelevantOnly
SecAuditLog /var/log/profithack/waf_audit.log
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecDebugLog /var/log/profithack/waf_debug.log
SecDebugLogLevel 3

# ============================================================================
# Performance Tuning
# ============================================================================

SecRequestBodyLimit 104857600
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecResponseBodyLimit 524288
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# ============================================================================
# END OF WAF RULES
# ============================================================================
