# PROFITHACK AI - Centralized Logging Configuration
# Ships logs from all services to ELK/Loki stack

# ============================================================================
# Log Shipper Configuration (Filebeat / Fluentd / Promtail Compatible)
# ============================================================================

# Global Settings
global:
  log_level: info
  output_format: json
  buffer_size: 10MB
  flush_interval: 10s

# ============================================================================
# Input Sources - Collect logs from all services
# ============================================================================
inputs:
  # Node.js API Gateway Logs
  - type: file
    path: /var/log/profithack_nodejs.log
    tags:
      - nodejs
      - api-gateway
      - production
    fields:
      service: nodejs-api-gateway
      environment: production
    multiline:
      pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
      negate: true
      match: after

  # Golang Feed Service Logs
  - type: file
    path: /var/log/profithack_golang_feed.log
    tags:
      - golang
      - feed-service
      - grpc
      - production
    fields:
      service: golang-feed-service
      environment: production

  # Python XAI Service Logs
  - type: file
    path: /var/log/profithack_python_xai.log
    tags:
      - python
      - xai
      - recommendation
      - production
    fields:
      service: python-xai-service
      environment: production

  # Video Processing Worker Logs
  - type: file
    path: /var/log/profithack_video_worker.log
    tags:
      - video-processing
      - bullmq
      - ffmpeg
      - production
    fields:
      service: video-processing-worker
      environment: production

  # Dating Matching Service Logs
  - type: file
    path: /var/log/profithack_dating.log
    tags:
      - dating
      - matching
      - ai
      - production
    fields:
      service: dating-matching-service
      environment: production

  # Nginx Access Logs
  - type: file
    path: /var/log/nginx/access.log
    tags:
      - nginx
      - access-log
      - production
    fields:
      service: nginx-load-balancer
      environment: production
    format: nginx

  # Nginx Error Logs
  - type: file
    path: /var/log/nginx/error.log
    tags:
      - nginx
      - error-log
      - production
    fields:
      service: nginx-load-balancer
      environment: production
      severity: error

  # System Logs
  - type: journald
    units:
      - docker.service
      - profithack-*
    tags:
      - system
      - docker
      - production

# ============================================================================
# Processors - Transform and enrich logs
# ============================================================================
processors:
  # Add hostname
  - add_host_metadata:
      when.not.contains.tags: forwarded

  # Add Kubernetes metadata (if running in k8s)
  - add_kubernetes_metadata:
      in_cluster: true

  # Extract error patterns
  - dissect:
      tokenizer: "%{timestamp} %{level} %{message}"
      field: message
      target_prefix: parsed

  # Drop debug logs in production
  - drop_event:
      when:
        equals:
          parsed.level: DEBUG

  # Add custom fields
  - add_fields:
      target: metadata
      fields:
        platform: profithack-ai
        version: 1.0.0
        region: us-east-1

# ============================================================================
# Output Destinations
# ============================================================================
outputs:
  # Primary: Elasticsearch (ELK Stack)
  elasticsearch:
    enabled: true
    hosts:
      - "https://elasticsearch.profithack.internal:9200"
    index: "profithack-logs-%{+yyyy.MM.dd}"
    username: "${ELASTICSEARCH_USERNAME}"
    password: "${ELASTICSEARCH_PASSWORD}"
    ssl:
      verification_mode: certificate
      certificate_authorities: ["/etc/pki/tls/certs/ca.crt"]
    bulk_max_size: 1000
    timeout: 30s

  # Secondary: Loki (Grafana Loki)
  loki:
    enabled: true
    url: "https://loki.profithack.internal:3100/loki/api/v1/push"
    tenant_id: "profithack-production"
    labels:
      job: "profithack-logs"
    max_retries: 3
    timeout: 10s

  # Backup: S3 for long-term storage
  s3:
    enabled: true
    bucket: "profithack-logs-archive"
    region: "us-east-1"
    path_prefix: "logs/%{+yyyy}/%{+MM}/%{+dd}/"
    compression: gzip
    rotation:
      max_size: 100MB
      max_age: 24h

  # Development: Console output
  console:
    enabled: false  # Disable in production
    pretty: true

# ============================================================================
# Error Handling & Aggregation
# ============================================================================
error_handling:
  # Aggregate similar errors
  aggregation:
    enabled: true
    window: 5m
    threshold: 10  # If 10+ similar errors, aggregate them

  # Alert on critical errors
  alerts:
    - name: "Critical Error Spike"
      condition: "error_count > 100 in 1m"
      channels:
        - slack
        - pagerduty

# ============================================================================
# Log Retention Policies
# ============================================================================
retention:
  # Hot storage (searchable, fast)
  hot:
    duration: 7d
    storage: elasticsearch

  # Warm storage (searchable, slower)
  warm:
    duration: 30d
    storage: elasticsearch-warm

  # Cold storage (archived, S3)
  cold:
    duration: 365d
    storage: s3-glacier

# ============================================================================
# Performance Tuning
# ============================================================================
performance:
  workers: 4
  queue_size: 4096
  batch_size: 1000
  flush_interval: 10s
  compression: gzip

# ============================================================================
# Security
# ============================================================================
security:
  # PII Detection & Redaction
  pii_redaction:
    enabled: true
    patterns:
      - email
      - phone
      - ssn
      - credit_card
      - api_key
      - password
    replacement: "[REDACTED]"

  # Encryption in transit
  tls:
    enabled: true
    verify: true
    certificate: "/etc/ssl/certs/profithack.crt"
    key: "/etc/ssl/private/profithack.key"

# ============================================================================
# Example Log Queries (For Reference)
# ============================================================================
# 
# Find all errors in last hour:
#   level:ERROR AND @timestamp:[now-1h TO now]
#
# Find slow API requests:
#   service:nodejs-api-gateway AND duration_ms:>1000
#
# Find failed payments:
#   tags:payment AND status:failed
#
# Find gRPC errors:
#   service:golang-feed-service AND grpc_status_code:!=0
#
# ============================================================================
