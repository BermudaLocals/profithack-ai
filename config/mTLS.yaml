# PROFITHACK AI - Mutual TLS (mTLS) Configuration
# 
# Security configuration for service-to-service communication
# 
# mTLS ensures that:
# 1. All microservices authenticate each other (not just server auth)
# 2. Traffic between services is encrypted end-to-end
# 3. Zero-trust security model (never trust, always verify)
#
# Production deployment: Use this config with Istio/Linkerd service mesh

---
# Certificate Authority (CA) Configuration
ca:
  # Root CA certificate (self-signed or from trusted CA)
  cert_file: /etc/profithack/certs/ca-cert.pem
  key_file: /etc/profithack/certs/ca-key.pem
  
  # Certificate validity period
  validity_days: 365
  
  # Certificate metadata
  organization: "PROFITHACK AI"
  country: "US"
  state: "California"
  locality: "San Francisco"

# Service-specific certificates
services:
  # Node.js API Server
  api_server:
    cert_file: /etc/profithack/certs/api-server-cert.pem
    key_file: /etc/profithack/certs/api-server-key.pem
    common_name: api-server.profithack.local
    sans:  # Subject Alternative Names
      - api-server.profithack.svc.cluster.local
      - api-server
      - localhost

  # Golang Feed Service (gRPC)
  feed_service:
    cert_file: /etc/profithack/certs/feed-service-cert.pem
    key_file: /etc/profithack/certs/feed-service-key.pem
    common_name: feed-service.profithack.local
    sans:
      - feed-service.profithack.svc.cluster.local
      - feed-service
      - localhost
    grpc_port: 50051

  # Video Transcoding Service
  transcode_service:
    cert_file: /etc/profithack/certs/transcode-service-cert.pem
    key_file: /etc/profithack/certs/transcode-service-key.pem
    common_name: transcode-service.profithack.local
    sans:
      - transcode-service.profithack.svc.cluster.local
      - transcode-service

  # ML Recommendation Engine
  ml_service:
    cert_file: /etc/profithack/certs/ml-service-cert.pem
    key_file: /etc/profithack/certs/ml-service-key.pem
    common_name: ml-service.profithack.local
    sans:
      - ml-service.profithack.svc.cluster.local
      - ml-service

# mTLS Policy
policy:
  # Require mTLS for all inter-service communication
  mode: STRICT  # Options: PERMISSIVE, STRICT
  
  # Minimum TLS version
  min_tls_version: TLS1_3
  
  # Allowed cipher suites (TLS 1.3)
  cipher_suites:
    - TLS_AES_128_GCM_SHA256
    - TLS_AES_256_GCM_SHA384
    - TLS_CHACHA20_POLY1305_SHA256
  
  # Certificate rotation
  auto_rotate: true
  rotation_days_before_expiry: 30
  
  # Certificate revocation
  enable_crl: true  # Certificate Revocation List
  crl_url: https://certs.profithack.ai/crl.pem

# Service Mesh Integration (Istio/Linkerd)
service_mesh:
  enabled: true
  provider: istio  # Options: istio, linkerd, consul
  
  # Istio-specific configuration
  istio:
    namespace: profithack
    mtls_mode: STRICT
    
    # Peer authentication
    peer_authentication:
      - name: default
        mtls_mode: STRICT
    
    # Destination rules
    destination_rules:
      - name: feed-service
        host: feed-service.profithack.svc.cluster.local
        traffic_policy:
          tls:
            mode: ISTIO_MUTUAL

# Monitoring & Auditing
monitoring:
  # Log all mTLS handshakes
  log_handshakes: true
  
  # Alert on certificate expiration
  alert_days_before_expiry: 7
  
  # Metrics endpoint
  metrics_port: 9090
  metrics_path: /metrics

# Development/Testing Configuration
development:
  # Disable mTLS in local development
  disable_mtls: true
  
  # Use self-signed certificates
  use_self_signed: true
  
  # Skip certificate validation (DEV ONLY!)
  skip_verification: true

---
# Usage Instructions:
#
# 1. Generate CA certificate:
#    openssl req -x509 -new -nodes -key ca-key.pem -sha256 -days 365 -out ca-cert.pem
#
# 2. Generate service certificates:
#    openssl req -new -key api-server-key.pem -out api-server-csr.pem
#    openssl x509 -req -in api-server-csr.pem -CA ca-cert.pem -CAkey ca-key.pem \
#      -CAcreateserial -out api-server-cert.pem -days 365 -sha256
#
# 3. Configure gRPC client (Node.js):
#    const credentials = grpc.credentials.createSsl(
#      fs.readFileSync('/etc/profithack/certs/ca-cert.pem'),
#      fs.readFileSync('/etc/profithack/certs/api-server-key.pem'),
#      fs.readFileSync('/etc/profithack/certs/api-server-cert.pem')
#    );
#
# 4. Configure gRPC server (Golang):
#    creds, _ := credentials.NewServerTLSFromFile(
#      "/etc/profithack/certs/feed-service-cert.pem",
#      "/etc/profithack/certs/feed-service-key.pem"
#    )
#    s := grpc.NewServer(grpc.Creds(creds))
#
# 5. Deploy with Kubernetes:
#    kubectl create secret tls profithack-certs \
#      --cert=api-server-cert.pem \
#      --key=api-server-key.pem \
#      -n profithack
