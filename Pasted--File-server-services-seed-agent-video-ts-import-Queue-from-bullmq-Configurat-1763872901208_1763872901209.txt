// File: server/services/seed_agent_video.ts

import { Queue } from 'bullmq';

// --- Configuration ---
// NOTE: This ID should be stored securely in environment variables or a configuration service.
const FOUNDERS_ACCOUNT_ID: string = "FOUNDERS_ACCOUNT_UUID_12345"; 
const VIDEO_PROCESSING_QUEUE_NAME: string = "videoProcessingQueue";

// Assume the BullMQ queue instance is initialized elsewhere and exported
// Example: export const videoQueue = new Queue(VIDEO_PROCESSING_QUEUE_NAME, { connection: redisConnection });
declare const videoQueue: Queue; 

/**
 * Interface for the data payload sent to the video processing service.
 */
interface VideoJobPayload {
    videoUrl: string;
    sourceUserId: string;
    metadata: {
        title: string;
        tags: string[];
        isAgentGenerated: boolean;
    };
}

/**
 * Triggers the video processing pipeline for an agent-generated video,
 * ensuring it is correctly attributed to the Founders Account for seeding.
 * 
 * @param agentVideoUrl The S3 URL of the raw video file generated by the agent.
 * @param agentMetadata The title and tags generated by the agent.
 */
export async function seedAgentVideo(agentVideoUrl: string, agentMetadata: { title: string, tags: string[] }): Promise<void> {
    if (!videoQueue) {
        console.error("Video processing queue is not initialized.");
        throw new Error("Queue initialization failure.");
    }

    const jobPayload: VideoJobPayload = {
        videoUrl: agentVideoUrl,
        // CRITICAL: Overwrite the sourceUserId with the Founders Account ID
        sourceUserId: FOUNDERS_ACCOUNT_ID, 
        metadata: {
            title: agentMetadata.title,
            tags: [...agentMetadata.tags, "agent-seed", "founders-content"], // Add special tags for tracking
            isAgentGenerated: true,
        },
    };

    try {
        await videoQueue.add(
            "processAgentVideo", // Job name
            jobPayload,
            { 
                // Prioritize agent-seeded content to ensure the FYP is always fresh
                priority: 1, 
                removeOnComplete: true 
            }
        );
        console.log(`Successfully added agent video job for Founders Account: ${jobPayload.metadata.title}`);
    } catch (error) {
        console.error("Failed to add agent video job to queue:", error);
        throw error;
    }
}

// --- Example Usage (This would be called by the 200 Agents System) ---
/*
// Example of an agent generating a video and calling this function
const agentOutput = {
    url: "s3://profithack-raw/agent-video-20251123.mp4",
    title: "Golang Microservice Tutorial in 60 Seconds",
    tags: ["golang", "microservices", "tutorial"]
};

// In the 200 Agents System's final step:
// seedAgentVideo(agentOutput.url, { title: agentOutput.title, tags: agentOutput.tags });